<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GROVE | MS Pipe Cut Length Calculator</title>

<style>
:root{
  --bg:#070707;
  --line:rgba(255,255,255,.12);
  --text:#f5f5f5;
  --muted:rgba(255,255,255,.65);
  --red:#ef2a1f;
  --radius:22px;
  --shadow:0 20px 60px rgba(0,0,0,.55);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  color:var(--text);
  background:var(--bg);
  min-height:100vh;
  padding:24px;
  overflow-x:hidden;
}
.bgGlow{
  position:fixed; inset:-40%;
  background:
    radial-gradient(900px 500px at 15% 15%, rgba(239,42,31,.14), transparent 60%),
    radial-gradient(700px 450px at 85% 35%, rgba(255,255,255,.05), transparent 60%);
  filter: blur(14px);
  animation: float 12s ease-in-out infinite alternate;
  pointer-events:none;
  z-index:-3;
}
@keyframes float{ from{transform:translate(-1%,-1%)} to{transform:translate(1%,1%)} }

.wrap{max-width:1000px;margin:0 auto;position:relative}

/* watermark zoom */
.wm-center{
  position:absolute; left:50%; top:55%;
  width:72%; max-width:760px;
  transform: translate(-50%, -50%);
  pointer-events:none; z-index:-1;
  animation: zoomBreath 16s ease-in-out infinite;
}
.wm-center img{
  width:100%;
  opacity:.10;
  filter: grayscale(100%) contrast(115%);
  position:relative; z-index:2;
}
.wm-glow{
  position:absolute; inset:-20%;
  background: radial-gradient(circle at center, rgba(255,255,255,.25), rgba(255,255,255,0) 65%);
  filter: blur(14px); z-index:1;
}
@keyframes zoomBreath{
  0%{transform:translate(-50%,-50%) scale(1)}
  50%{transform:translate(-50%,-50%) scale(1.05)}
  100%{transform:translate(-50%,-50%) scale(1)}
}

/* header */
.topbar{
  display:flex; justify-content:space-between; align-items:center;
  gap:12px; margin-bottom:16px;
}
.logoPlate{
  background:#fff;
  padding:10px 14px;
  border-radius:16px;
  box-shadow:0 12px 30px rgba(0,0,0,.35);
}
.logoPlate img{height:46px}
.topRight{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.pill{
  font-size:12px; font-weight:800; color:var(--muted);
  border:1px solid var(--line);
  padding:9px 12px; border-radius:999px;
  background:rgba(255,255,255,.03);
  display:flex; align-items:center; gap:10px;
}
.dot{
  width:9px;height:9px;border-radius:50%;
  background:var(--red);
  box-shadow:0 0 0 5px rgba(239,42,31,.18);
  animation:pulse 1.8s ease infinite;
}
@keyframes pulse{50%{transform:scale(1.1)}}
.btnSmall{
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  color:var(--text);
  font-weight:900;
  padding:9px 12px;
  border-radius:999px;
  cursor:pointer;
}

/* card */
.card{
  border:1px solid var(--line);
  border-radius:var(--radius);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  box-shadow:var(--shadow);
  overflow:hidden;
  position:relative;
  z-index:1;
}
.cardHead{
  padding:18px 22px;
  border-bottom:1px solid var(--line);
  background:rgba(0,0,0,.22);
}
h1{margin:0;font-size:24px}
.sub{margin-top:6px;color:var(--muted);line-height:1.55}

.content{
  padding:18px 22px 22px;
  display:grid;
  grid-template-columns: 1.15fr .85fr;
  gap:16px;
}
@media(max-width:900px){
  .content{grid-template-columns:1fr}
  .wm-center{display:none}
}

/* blocks */
.block{
  border:1px solid var(--line);
  border-radius:18px;
  background:rgba(0,0,0,.20);
  padding:14px;
}
.blockTitle{
  display:flex; align-items:center; gap:10px;
  font-weight:900; margin-bottom:10px;
}
.stepNum{
  width:28px;height:28px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(239,42,31,.18);
  border:1px solid rgba(239,42,31,.35);
}
label{
  display:block;
  font-size:12px;
  font-weight:900;
  margin:10px 0 6px;
  color:rgba(255,255,255,.82);
}
select,input,textarea{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.05);
  color:var(--text);
  font-size:15px;
  outline:none;
}
select option{background:#111;color:#fff}
input::placeholder, textarea::placeholder{color:rgba(255,255,255,.35)}
textarea{min-height:88px;resize:vertical}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:700px){.row2{grid-template-columns:1fr}}

.help{margin-top:10px;color:rgba(255,255,255,.55);font-size:12px;line-height:1.5;}
.warn{
  display:none; margin-top:12px; padding:12px 14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.03);
  color:rgba(255,255,255,.70);
  font-size:12px; line-height:1.5;
}

.resultCard{
  border:1px solid rgba(239,42,31,.35);
  background: rgba(239,42,31,.08);
  border-radius:18px;
  padding:16px;
}
.resultLabel{font-size:12px;font-weight:900;color:rgba(255,255,255,.72)}
.resultValue{font-size:38px;font-weight:1000;margin-top:6px}
.meta{
  margin-top:10px;
  display:flex; flex-wrap:wrap; gap:10px;
  font-size:12px; color:rgba(255,255,255,.70);
}
.metaPill{
  border:1px solid var(--line);
  background:rgba(255,255,255,.03);
  padding:7px 10px;
  border-radius:999px;
}

/* QR preview (BIGGER + clickable + fallback) */
.qrPreview{
  margin-top:12px;
  display:none;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.03);
  border-radius:16px;
  padding:12px;
}
.qrPreview .txt{
  color:rgba(255,255,255,.70);
  font-size:12px;
  line-height:1.45;
}
.qrBox{
  width:160px;height:160px;   /* bigger */
  background:#fff;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  flex:0 0 auto;
  cursor:pointer;
  border:6px solid #fff;      /* stronger quiet zone */
}
.qrBox canvas{width:160px;height:160px;display:block}

.linkRow{
  margin-top:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
.linkRow a{
  color:#fff;
  font-weight:900;
  text-decoration:none;
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  padding:10px 12px;
  border-radius:14px;
  display:inline-flex;
  align-items:center;
  gap:8px;
}

.copyRow{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.btnPrimary{
  border:none;
  padding:13px 14px;
  border-radius:14px;
  background:linear-gradient(180deg,#ff3b30,var(--red));
  color:#fff;
  font-weight:900;
  cursor:pointer;
  flex:1;
  min-width:160px;
}
.btnGhost{
  border:1px solid var(--line);
  background:rgba(255,255,255,.04);
  color:#fff;
  font-weight:900;
  padding:13px 14px;
  border-radius:14px;
  cursor:pointer;
  flex:1;
  min-width:160px;
}
.btnGhost:disabled{opacity:.5;cursor:not-allowed}
.toast{margin-top:10px;font-size:12px;color:rgba(255,255,255,.70);display:none}

.footer{
  border-top:1px solid var(--line);
  padding:14px 22px;
  font-size:12px;
  color:rgba(255,255,255,.45);
  display:flex;
  justify-content:space-between;
  background:rgba(0,0,0,.18);
}

/* PRINT */
#printSlip{ display:none; }
@media print{
  @page{ size: A6; margin: 8mm; }
  body{ background:#fff !important; color:#000 !important; padding:0 !important; }
  .bgGlow,.wm-center,.topbar,.card,.wrap{ display:none !important; }
  #printSlip{ display:block !important; }

  #printSlip{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color:#000; }
  .slipBox{ border:1px solid #000; padding:10px; border-radius:10px; }
  .slipHeader{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px; }
  .slipHeader img{ height:30px; width:auto; }
  .slipTitle{ font-weight:1000; font-size:14px; text-align:right; }
  .slipTopRow{ display:flex; gap:10px; align-items:stretch; }
  .bigCut{
    flex:1 1 auto; font-size:28px; font-weight:1000; padding:8px;
    border:1px solid #000; border-radius:10px; text-align:center;
    display:flex; align-items:center; justify-content:center;
  }
  .printQR{
    width:110px;height:110px; border:1px solid #000; border-radius:10px;
    overflow:hidden; display:flex; align-items:center; justify-content:center; background:#fff; flex:0 0 auto;
    padding:6px;
  }
  .printQR canvas{ width:98px;height:98px; display:block; }

  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; font-size:11px; margin-top:10px; }
  .row{ border:1px solid #000; border-radius:10px; padding:8px; }
  .k{font-weight:900; font-size:10px; opacity:.85}
  .v{margin-top:4px; font-weight:800}

  .notes{ margin-top:8px; border:1px solid #000; border-radius:10px; padding:8px; font-size:11px; min-height:34px; }
  .tiny{ margin-top:8px; font-size:10px; opacity:.85; display:flex; justify-content:space-between; gap:10px; }
}
</style>
</head>

<body>
<div class="bgGlow"></div>

<script>
if (sessionStorage.getItem("cutcalc_ok") !== "1") {
  window.location.href = "index.html";
}
</script>

<div class="wrap">
  <div class="wm-center" aria-hidden="true">
    <div class="wm-glow"></div>
    <img src="grove-logo.png" alt="">
  </div>

  <div class="topbar">
    <div class="logoPlate">
      <img src="grove-logo.png" alt="GROVE">
    </div>
    <div class="topRight">
      <div class="pill"><span class="dot"></span>MS Pipes • Calculator</div>
      <button class="btnSmall" onclick="window.location.href='pipe-type.html'">← Pipe Type</button>
      <button class="btnSmall" onclick="sessionStorage.clear(); location.href='index.html'">Exit</button>
    </div>
  </div>

  <div class="card">
    <div class="cardHead">
      <h1>Pipe Cut Length Calculator</h1>
      <div class="sub">Cut Length = CTC − (Offset A + Offset B). QR opens GROVE slip page.</div>
    </div>

    <div class="content">
      <div class="block">
        <div class="blockTitle"><div class="stepNum">1</div> Pipe size</div>
        <label>Pipe Size</label>
        <select id="size"></select>
        <div class="help">Shows inch + ID/OD (mm).</div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.10);margin:14px 0;">

        <div class="blockTitle"><div class="stepNum">2</div> Fittings (both ends)</div>
        <div class="row2">
          <div>
            <label>End A</label>
            <select id="endA"></select>
          </div>
          <div>
            <label>End B</label>
            <select id="endB"></select>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,.10);margin:14px 0;">

        <div class="blockTitle"><div class="stepNum">3</div> Centre-to-centre</div>
        <label>CTC (mm)</label>
        <input id="ctc" type="number" inputmode="numeric" placeholder="e.g. 1200">

        <label style="margin-top:14px;">Notes (optional)</label>
        <textarea id="notes" placeholder="e.g. Room/Line/Level, fitter name, drawing ref…"></textarea>

        <div class="warn" id="warn"></div>
      </div>

      <div class="block">
        <div class="blockTitle"><div class="stepNum">✓</div> Result</div>

        <div class="resultCard">
          <div class="resultLabel">Cut length</div>
          <div id="cut" class="resultValue">—</div>
          <div id="formula" class="help">Enter CTC to calculate.</div>

          <div class="meta" id="meta"></div>

          <div class="qrPreview" id="qrPreview">
            <div class="txt">
              <b>Scan QR → GROVE Cut Slip</b><br>
              If iPhone camera doesn’t detect it, just tap “Open Slip”.
              <div style="margin-top:6px;opacity:.8;" id="qrHint">—</div>

              <div class="linkRow">
                <a id="openSlip" href="#" target="_blank" rel="noopener">Open Slip ↗</a>
                <a href="#" onclick="copySlipLink();return false;">Copy Slip Link</a>
              </div>
            </div>

            <div class="qrBox" title="Tap to open slip" onclick="openSlipNow()">
              <canvas id="qrCanvas" width="160" height="160"></canvas>
            </div>
          </div>

          <div class="copyRow">
            <button id="copyBtn" class="btnGhost" disabled onclick="copyResult()">Copy Result</button>
            <button id="printBtn" class="btnGhost" disabled onclick="printSlip()">Print Cut Slip</button>
            <button class="btnPrimary" onclick="resetAll()">Reset</button>
          </div>
          <div class="toast" id="toast">Done ✅</div>
        </div>

        <div class="help" style="margin-top:12px;">
          Works in Brave: QR is generated fully offline.
        </div>
      </div>
    </div>

    <div class="footer">
      <div>© GROVE Services Ltd.</div>
      <div>Internal use only</div>
    </div>
  </div>
</div>

<!-- PRINT ONLY SLIP -->
<div id="printSlip">
  <div class="slipBox">
    <div class="slipHeader">
      <img src="grove-logo.png" alt="GROVE">
      <div class="slipTitle">MS CUT SLIP</div>
    </div>

    <div class="slipTopRow">
      <div class="bigCut" id="slipCut">—</div>
      <div class="printQR">
        <canvas id="qrCanvasPrint" width="110" height="110"></canvas>
      </div>
    </div>

    <div class="grid">
      <div class="row"><div class="k">PIPE SIZE</div><div class="v" id="slipSize">—</div></div>
      <div class="row"><div class="k">ID / OD</div><div class="v" id="slipIdOd">—</div></div>
      <div class="row"><div class="k">END A</div><div class="v" id="slipEndA">—</div></div>
      <div class="row"><div class="k">END B</div><div class="v" id="slipEndB">—</div></div>
      <div class="row"><div class="k">CTC (mm)</div><div class="v" id="slipCtc">—</div></div>
      <div class="row"><div class="k">OFFSETS</div><div class="v" id="slipOffsets">—</div></div>
    </div>

    <div class="notes">
      <div class="k">NOTES</div>
      <div class="v" id="slipNotes" style="font-weight:700;">—</div>
    </div>

    <div class="tiny">
      <div id="slipTime">—</div>
      <div>Cut Length = CTC − (A + B)</div>
    </div>
  </div>
</div>

<script>
/* ===== OFFLINE QR LIB (qrcode-generator, minified-ish) ===== */
(function(){
/* eslint-disable */
var qrcode=function(){function n(n,t){this.typeNumber=n,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function t(n,t){if(void 0==n.length)throw new Error(n.length+"/"+t);for(var e=0;e<n.length&&0==n[e];)e++;this.num=new Array(n.length-e+t);for(var r=0;r<n.length-e;r++)this.num[r]=n[r+e]}function e(){this.buffer=[],this.length=0}function r(n){this.mode=4,this.data=n,this.parsedData=[];for(var t=0;t<this.data.length;t++){var e=this.data.charCodeAt(t);e>255?this.parsedData.push(191):this.parsedData.push(e)}this.getLength=function(){return this.parsedData.length},this.write=function(n){for(var t=0;t<this.parsedData.length;t++)n.put(this.parsedData[t],8)}}var o={PAD0:236,PAD1:17,createData:function(n,t,e){for(var r=u.getRSBlocks(n,t),o=new i,a=0;a<e.length;a++){var f=e[a];o.put(f.mode,4),o.put(f.getLength(),u.getLengthInBits(f.mode,n)),f.write(o)}for(var h=0,a=0;a<r.length;a++)h+=r[a].dataCount;if(o.getLengthInBits()>8*h)throw new Error("code length overflow");for(o.getLengthInBits()+4<=8*h&&o.put(0,4);o.getLengthInBits()%8!=0;)o.putBit(!1);for(;!(o.getLengthInBits()>=8*h);){if(o.put(this.PAD0,8),o.getLengthInBits()>=8*h)break;o.put(this.PAD1,8)}return this.createBytes(o,r)},createBytes:function(n,e){for(var r=0,o=0,i=0;i<e.length;i++){var a=e[i];r=Math.max(r,a.dataCount),o=Math.max(o,a.totalCount-a.dataCount)}for(var f=new Array(e.length),h=0;h<e.length;h++){var l=e[h],c=l.dataCount,s=l.totalCount-c;f[h]=new Array(l.totalCount);for(var d=0;d<c;d++)f[h][d]=255&n.buffer[d+h*c];var g=u.getErrorCorrectPolynomial(s),p=new t(f[h],g.getLength()-1).mod(g);for(d=0;d<s;d++){var v=d+p.getLength()-s;f[h][c+d]=v>=0?p.get(v):0}}for(var m=0,i=0;i<e.length;i++)m+=e[i].totalCount;for(var y=new Array(m),b=0,d=0;d<r;d++)for(i=0;i<e.length;i++)d<e[i].dataCount&&(y[b++]=f[i][d]);for(d=0;d<o;d++)for(i=0;i<e.length;i++){var w=e[i].totalCount-e[i].dataCount;d<w&&(y[b++]=f[i][e[i].dataCount+d])}return y}};var i=function(){function n(){this.buffer=[],this.length=0}return n.prototype={get:function(n){var t=Math.floor(n/8);return 1==(this.buffer[t]>>>7-n%8&1)},put:function(n,t){for(var e=0;e<t;e++)this.putBit(1==(n>>>t-e-1&1))},putBit:function(n){var t=Math.floor(this.length/8);this.buffer.length<=t&&this.buffer.push(0),n&&(this.buffer[t]|=128>>>this.length%8),this.length++},getLengthInBits:function(){return this.length}},n}();var a=function(n,t){this.totalCount=n,this.dataCount=t};var f=function(){function n(){}return n.RS_BLOCK_TABLE=[[],[1,26,19],[1,26,16],[1,26,13],[1,26,9],[1,44,34],[1,44,28],[1,44,22],[1,44,16],[1,70,55],[1,70,44],[2,35,17],[2,35,13],[2,35,10],[2,35,7],[1,100,80],[2,50,32],[2,50,24],[4,25,9],[4,25,7],[1,134,108],[2,67,43],[2,67,32],[4,33,15],[4,33,11],[2,86,68],[4,43,27],[4,43,19],[4,43,15],[6,43,11],[2,98,78],[4,49,31],[2,32,14],[4,39,13],[4,39,10],[6,39,7],[2,121,97],[2,60,38],[4,40,18],[4,40,14],[4,40,11],[6,40,8],[2,146,116],[3,58,36],[4,36,16],[4,36,12],[4,36,10],[6,36,8]],n.getRSBlocks=function(n,t){var e=this.getRsBlockTable(n,t);if(!e)throw new Error("bad rs block");for(var r=e.length/3,o=[],i=0;i<r;i++)for(var f=e[3*i+0],h=e[3*i+1],l=e[3*i+2],c=0;c<f;c++)o.push(new a(h,l));return o},n.getRsBlockTable=function(n,t){switch(t){case 1:return this.RS_BLOCK_TABLE[4*(n-1)+1];case 0:return this.RS_BLOCK_TABLE[4*(n-1)+2];case 3:return this.RS_BLOCK_TABLE[4*(n-1)+3];case 2:return this.RS_BLOCK_TABLE[4*(n-1)+4];default:return null}},n}();var h={EXP_TABLE:new Array(256),LOG_TABLE:new Array(256),glog:function(n){if(n<1)throw new Error("glog");return this.LOG_TABLE[n]},gexp:function(n){for(;n<0;)n+=255;for(;n>=256;)n-=255;return this.EXP_TABLE[n]}};(function(){for(var n=0;n<8;n++)h.EXP_TABLE[n]=1<<n;for(n=8;n<256;n++)h.EXP_TABLE[n]=h.EXP_TABLE[n-4]^h.EXP_TABLE[n-5]^h.EXP_TABLE[n-6]^h.EXP_TABLE[n-8];for(n=0;n<255;n++)h.LOG_TABLE[h.EXP_TABLE[n]]=n})();var l={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50]],G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(n){for(var t=n<<10;this.getBCHDigit(t)-this.getBCHDigit(this.G15)>=0;)t^=this.G15<<this.getBCHDigit(t)-this.getBCHDigit(this.G15);return(n<<10|t)^this.G15_MASK},getBCHDigit:function(n){for(var t=0;0!=n;)t++,n>>>=1;return t},getMask:function(n,t,e){switch(n){case 0:return(t+e)%2==0;case 1:return t%2==0;case 2:return e%3==0;case 3:return(t+e)%3==0;default:return(t+e)%2==0}},getPatternPosition:function(n){return this.PATTERN_POSITION_TABLE[n-1]||[6,18]}};var u={getLengthInBits:function(){return 8},getErrorCorrectPolynomial:function(n){for(var t=new t([1],0),e=0;e<n;e++)t=t.multiply(new t([1,h.gexp(e)],0));return t},getRSBlocks:f.getRSBlocks};t.prototype={get:function(n){return this.num[n]},getLength:function(){return this.num.length},multiply:function(n){for(var t=new Array(this.getLength()+n.getLength()-1),e=0;e<t.length;e++)t[e]=0;for(e=0;e<this.getLength();e++)for(var r=0;r<n.getLength();r++)t[e+r]^=h.gexp(h.glog(this.get(e))+h.glog(n.get(r)));return new t(t,0)},mod:function(n){if(this.getLength()-n.getLength()<0)return this;for(var e=h.glog(this.get(0))-h.glog(n.get(0)),r=new Array(this.getLength()),o=0;o<this.getLength();o++)r[o]=this.get(o);for(o=0;o<n.getLength();o++)r[o]^=h.gexp(h.glog(n.get(o))+e);return new t(r,0).mod(n)}};n.prototype={addData:function(n){this.dataList.push(new r(n)),this.dataCache=null},isDark:function(n,t){return this.modules[n][t]},getModuleCount:function(){return this.moduleCount},make:function(){this.typeNumber=2;this.makeImpl(false,0)},makeImpl:function(n,t){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var e=0;e<this.moduleCount;e++){this.modules[e]=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++)this.modules[e][r]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupTimingPattern(),this.setupTypeInfo(n,t),null==this.dataCache&&(this.dataCache=o.createData(this.typeNumber,1,this.dataList)),this.mapData(this.dataCache,t)},setupPositionProbePattern:function(n,t){for(var e=-1;e<=7;e++)if(!(n+e<=-1||this.moduleCount<=n+e))for(var r=-1;r<=7;r++)t+r<=-1||this.moduleCount<=t+r||(0<=e&&e<=6&&(0==r||6==r)||0<=r&&r<=6&&(0==e||6==e)||2<=e&&e<=4&&2<=r&&r<=4?this.modules[n+e][t+r]=true:this.modules[n+e][t+r]=false)},setupTimingPattern:function(){for(var n=8;n<this.moduleCount-8;n++)null==this.modules[n][6]&&(this.modules[n][6]=n%2==0),null==this.modules[6][n]&&(this.modules[6][n]=n%2==0)},setupTypeInfo:function(n,t){for(var e=l.getBCHTypeInfo(1<<3|t),r=0;r<15;r++){var o=!n&&1==(e>>r&1);r<6?this.modules[r][8]=o:r<8?this.modules[r+1][8]=o:this.modules[this.moduleCount-15+r][8]=o,r<8?this.modules[8][this.moduleCount-r-1]=o:r<9?this.modules[8][15-r-1+1]=o:this.modules[8][15-r-1]=o}this.modules[this.moduleCount-8][8]=!n},mapData:function(n,t){for(var e=-1,r=this.moduleCount-1,o=7,i=0,a=this.moduleCount-1;a>0;a-=2)for(6==a&&a--;!0;){for(var f=0;f<2;f++)if(null==this.modules[r][a-f]){var h=false;i<n.length&&(h=1==(n[i]>>>o&1));var u=l.getMask(t,r,a-f);u&&(h=!h),this.modules[r][a-f]=h,--o,-1==o&&(i++,o=7)}if((r+=e)<0||this.moduleCount<=r){r-=e,e=-e;break}}}};window.qrcode=function(){return new n(0,1)};window.QRErrorCorrectLevel={M:0};
})();

/* ===== APP DATA (MS) ===== */
const DATA = {
  '1/2"':  { id:15,  od:21.3, flangeA:null, elbowC:38,  teeD:25,  teeE:50  },
  '3/4"':  { id:20,  od:26.9, flangeA:null, elbowC:38,  teeD:29,  teeE:58  },
  '1"':    { id:25,  od:33.7, flangeA:null, elbowC:38,  teeD:38,  teeE:76  },
  '1 1/4"':{ id:32,  od:42.4, flangeA:null, elbowC:48,  teeD:48,  teeE:96  },
  '1 1/2"':{ id:40,  od:48.3, flangeA:null, elbowC:57,  teeD:57,  teeE:114 },
  '2"':    { id:50,  od:60.3, flangeA:null, elbowC:76,  teeD:64,  teeE:128 },
  '2 1/2"':{ id:65,  od:76.1, flangeA:20,  elbowC:95,  teeD:76,  teeE:152 },
  '3"':    { id:80,  od:88.9, flangeA:20,  elbowC:114, teeD:86,  teeE:172 },
  '4"':    { id:100, od:114.3,flangeA:20,  elbowC:152, teeD:105, teeE:210 }
};
const FITTINGS = [
  { key:"flangeA", label:"Flange (A)" },
  { key:"elbowC",  label:"90° Elbow (C)" },
  { key:"teeD",    label:"Tee (D)" },
  { key:"teeE",    label:"Tee (E)" }
];

/* ===== UI REFS ===== */
const sizeSel   = document.getElementById("size");
const endA      = document.getElementById("endA");
const endB      = document.getElementById("endB");
const ctcEl     = document.getElementById("ctc");
const notesEl   = document.getElementById("notes");
const cutEl     = document.getElementById("cut");
const formulaEl = document.getElementById("formula");
const metaEl    = document.getElementById("meta");
const warnEl    = document.getElementById("warn");
const copyBtn   = document.getElementById("copyBtn");
const printBtn  = document.getElementById("printBtn");
const toast     = document.getElementById("toast");
const qrPreview = document.getElementById("qrPreview");
const qrHint    = document.getElementById("qrHint");
const openSlipA = document.getElementById("openSlip");

const qrCanvas      = document.getElementById("qrCanvas");
const qrCanvasPrint = document.getElementById("qrCanvasPrint");

/* slip */
const slipCut     = document.getElementById("slipCut");
const slipSize    = document.getElementById("slipSize");
const slipIdOd    = document.getElementById("slipIdOd");
const slipEndA    = document.getElementById("slipEndA");
const slipEndB    = document.getElementById("slipEndB");
const slipCtc     = document.getElementById("slipCtc");
const slipOffsets = document.getElementById("slipOffsets");
const slipNotes   = document.getElementById("slipNotes");
const slipTime    = document.getElementById("slipTime");

let lastCopyText = "";
let lastSlipData = null;
let lastQrUrl = "";

function showWarn(msg){ warnEl.style.display="block"; warnEl.textContent=msg; }
function clearWarn(){ warnEl.style.display="none"; warnEl.textContent=""; }
function setActions(enabled){
  copyBtn.disabled = !enabled;
  printBtn.disabled = !enabled;
  toast.style.display = "none";
  qrPreview.style.display = enabled ? "flex" : "none";
}
function nowStamp(){
  return new Date().toLocaleString(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
}
function timeKey(){
  const d = new Date();
  return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
}
function getBaseUrl(){
  const url = new URL(window.location.href);
  url.hash=""; url.search="";
  url.pathname = url.pathname.split("/").slice(0,-1).join("/") + "/";
  return url.toString();
}
function base64UnicodeEncode(obj){
  const json = JSON.stringify(obj);
  return btoa(unescape(encodeURIComponent(json)));
}
function makeQrUrl(d){
  const payloadObj = {
    s:d.size, i:d.id, o:d.od,
    a:d.endALabel, b:d.endBLabel,
    oa:d.offA, ob:d.offB,
    c:d.ctc, cut:d.cut,
    n:(d.notes||"").trim().slice(0,120),
    t:d.timeKey,
    tp: nowStamp()
  };
  const encoded = encodeURIComponent(base64UnicodeEncode(payloadObj));
  return `${getBaseUrl()}slip.html?d=${encoded}`;
}

/* REAL QR draw (Brave-safe) */
function drawQr(canvas, text){
  const qr = window.qrcode();
  qr.addData(text);
  qr.make();

  const ctx = canvas.getContext("2d");
  const size = canvas.width;

  ctx.fillStyle="#fff";
  ctx.fillRect(0,0,size,size);

  const count = qr.getModuleCount();
  const quiet = 4;
  const cells = count + quiet*2;
  const cell = Math.floor(size / cells);
  const offset = Math.floor((size - cell*cells)/2);

  for(let r=0;r<count;r++){
    for(let c=0;c<count;c++){
      ctx.fillStyle = qr.isDark(r,c) ? "#000" : "#fff";
      const x = offset + (c+quiet)*cell;
      const y = offset + (r+quiet)*cell;
      ctx.fillRect(x,y,cell,cell);
    }
  }
}
function updateQR(url){
  drawQr(qrCanvas, url);
  drawQr(qrCanvasPrint, url);
  qrHint.textContent = "Tap QR if camera doesn’t detect.";
  openSlipA.href = url;
}

function openSlipNow(){
  if(lastQrUrl) window.open(lastQrUrl, "_blank");
}
async function copySlipLink(){
  if(!lastQrUrl) return;
  try{ await navigator.clipboard.writeText(lastQrUrl); }
  catch(e){
    const ta=document.createElement("textarea"); ta.value=lastQrUrl;
    document.body.appendChild(ta); ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
  }
  toast.style.display="block"; toast.textContent="Slip link copied ✅";
  setTimeout(()=>toast.style.display="none",1200);
}

/* builders */
function buildSizeOptions(){
  sizeSel.innerHTML="";
  Object.keys(DATA).forEach(sz=>{
    const r=DATA[sz];
    const opt=document.createElement("option");
    opt.value=sz;
    opt.textContent=`${sz}  •  ID ${r.id}mm  •  OD ${r.od}mm`;
    sizeSel.appendChild(opt);
  });
  sizeSel.value='2"';
}
function buildFittingOptionsForSize(){
  const row = DATA[sizeSel.value];
  const prevA = endA.value || "elbowC";
  const prevB = endB.value || "elbowC";

  endA.innerHTML=""; endB.innerHTML="";

  const available = FITTINGS.filter(f => (f.key!=="flangeA") || (row.flangeA!==null));
  available.forEach(f=>{
    const oa=document.createElement("option"); oa.value=f.key; oa.textContent=f.label; endA.appendChild(oa);
    const ob=document.createElement("option"); ob.value=f.key; ob.textContent=f.label; endB.appendChild(ob);
  });

  endA.value = available.some(x=>x.key===prevA) ? prevA : "elbowC";
  endB.value = available.some(x=>x.key===prevB) ? prevB : "elbowC";
}
function updateSlip(d){
  slipCut.textContent = `${d.cut} mm`;
  slipSize.textContent = d.size;
  slipIdOd.textContent = `${d.id} / ${d.od} mm`;
  slipEndA.textContent = `${d.endALabel} (${d.offA}mm)`;
  slipEndB.textContent = `${d.endBLabel} (${d.offB}mm)`;
  slipCtc.textContent = `${d.ctc}`;
  slipOffsets.textContent = `A ${d.offA} + B ${d.offB}`;
  slipNotes.textContent = (d.notes && d.notes.trim()) ? d.notes.trim() : "—";
  slipTime.textContent = nowStamp();
}

function updateLive(){
  clearWarn();
  setActions(false);
  lastCopyText=""; lastSlipData=null; lastQrUrl="";

  const size=sizeSel.value;
  const row=DATA[size];
  const ctc=Number(ctcEl.value);

  if(!ctc || ctc<=0){
    cutEl.textContent="—";
    formulaEl.textContent="Enter CTC to calculate.";
    metaEl.innerHTML="";
    return;
  }

  const offA=row[endA.value];
  const offB=row[endB.value];

  if(offA==null || offB==null){
    cutEl.textContent="—";
    formulaEl.textContent="Offset missing.";
    metaEl.innerHTML="";
    showWarn("Selected fitting offset is not available for this size. Please choose another fitting.");
    return;
  }

  const cut = ctc - (offA + offB);
  const cutTxt = cut.toFixed(1);

  cutEl.textContent = `${cutTxt} mm`;
  formulaEl.textContent = `CTC ${ctc} − (A ${offA} + B ${offB})`;

  const endALabel = endA.options[endA.selectedIndex].text;
  const endBLabel = endB.options[endB.selectedIndex].text;

  metaEl.innerHTML = `
    <div class="metaPill"><b>Size:</b> ${size}</div>
    <div class="metaPill"><b>End A:</b> ${endALabel} (${offA}mm)</div>
    <div class="metaPill"><b>End B:</b> ${endBLabel} (${offB}mm)</div>
    <div class="metaPill"><b>ID/OD:</b> ${row.id} / ${row.od}mm</div>
  `;

  const notes = notesEl.value || "";
  const tk = timeKey();

  lastSlipData = { size,id:row.id,od:row.od,endALabel,endBLabel,offA,offB,ctc,cut:cutTxt,notes,timeKey:tk };
  updateSlip(lastSlipData);

  lastQrUrl = makeQrUrl(lastSlipData);
  updateQR(lastQrUrl);

  lastCopyText =
`GROVE MS Cut Length
Size: ${size} (ID ${row.id}mm, OD ${row.od}mm)
End A: ${endALabel} (${offA}mm)
End B: ${endBLabel} (${offB}mm)
CTC: ${ctc} mm
CUT: ${cutTxt} mm
Slip: ${lastQrUrl}`;

  setActions(true);
}

async function copyResult(){
  if(!lastCopyText) return;
  try{ await navigator.clipboard.writeText(lastCopyText); }
  catch(e){
    const ta=document.createElement("textarea"); ta.value=lastCopyText;
    document.body.appendChild(ta); ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
  }
  toast.style.display="block"; toast.textContent="Copied ✅";
  setTimeout(()=>toast.style.display="none",1200);
}
function printSlip(){
  if(!lastSlipData) return;
  updateSlip(lastSlipData);
  updateQR(lastQrUrl);
  toast.style.display="block"; toast.textContent="Opening print…";
  setTimeout(()=>{ window.print(); toast.style.display="none"; },200);
}
function resetAll(){
  sizeSel.value='2"';
  buildFittingOptionsForSize();
  ctcEl.value="";
  notesEl.value="";
  updateLive();
}

/* init */
buildSizeOptions();
buildFittingOptionsForSize();
sizeSel.addEventListener("change",()=>{buildFittingOptionsForSize();updateLive();});
endA.addEventListener("change",updateLive);
endB.addEventListener("change",updateLive);
ctcEl.addEventListener("input",updateLive);
notesEl.addEventListener("input",()=>{ if(lastSlipData) updateLive(); });
updateLive();
</script>

</body>
</html>
